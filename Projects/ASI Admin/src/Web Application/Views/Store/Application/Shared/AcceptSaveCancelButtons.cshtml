@using asi.asicentral.web.Controllers.Store
@using asi.asicentral.model.store;
@using asi.asicentral.interfaces;
@model asi.asicentral.web.store.interfaces.IMembershipModel
<div>
    @{
        var isBackEnd = IsBackEnd();
        var hasPendingTerms = HasPendingTerms();
    }

    @if (!string.IsNullOrEmpty(Model.ASINumber))
    {
        <h3>ASI #: @Model.ASINumber</h3>
    }
	@if (Model.OrderStatus == OrderStatus.Approved && !string.IsNullOrEmpty(Model.BackendReference))
	{
		<h3>Personify Order#: @Model.BackendReference</h3>
	}
    @if (Model.TotalCost >= 0.0m)
    {
	    <div><h3 class="order-status-header3">Order Status:</h3><div class="order-status">@Model.OrderStatus</div></div>
        if (isBackEnd && Model.OrderStatus == OrderStatus.PersonifyError)
        {
        <div class="order-status">
            <input class="command btn-primary" type="submit" value="@ApplicationController.COMMAND_RESUBMIT" /></div>
        }
        <div class="timms-info">
            <div class="span4">
                @if (!isBackEnd)
                {
                    <label class="order-status-label" for="Timms_ID">Constituent ID:</label>
                    <div class="order-status-input">
                        @Html.EditorFor(m => m.ExternalReference, new { @class = "span2" })
                        <span id="timmsErrorMessage" data-type="errormessage" class="field-validation-error"></span>
                    </div>
                }
                else
                {
                    <label class="order-status-label" for="Timms_ID">Constituent ID: @Model.ExternalReference</label>
                }
            </div>
            @if (hasPendingTerms)
            {
                <input data-type="boolean" id="hasPendingTerms" type="hidden" value="true" />
            }
            <div class="status-btns">
                @if (!isBackEnd)
                {
                    if (Model.IsCompleted && Model.OrderStatus != OrderStatus.Approved)
                    {
                    <input class="command btn-primary" type="submit" value="@ApplicationController.COMMAND_ACCEPT" />
                    }
                    if (Model.IsCompleted && (Model.OrderStatus == OrderStatus.Pending || Model.OrderStatus == OrderStatus.Approved) )
                    { 
                    <input class="command btn-primary" type="submit" value="@ApplicationController.COMMAND_REJECT" />
                    }
                    <input class="command btn-primary save" type="submit" value="@ApplicationController.COMMAND_SAVE" />

                    if (Model.OrderStatus == OrderStatus.Approved)
                    { @Html.ActionLink("Close", "../Orders") }
                    else
                    { @Html.ActionLink("Cancel", "../Orders") }
                }
                
                @if( Model.OrderStatus == OrderStatus.ErrorOverride)
                {
                    <input class="command btn-primary" type="submit" value="@ApplicationController.COMMAND_OVERRIDE" />
                }

            </div>
            <div id="termsWarningMessage" data-type="errormessage" class="field-validation-error span10"></div>
            @if (!isBackEnd && !string.IsNullOrEmpty(Model.ExternalReference))
            {
                <div class="span10">
                <p>(Please contact ASICentral team if this is not the Constituent ID expected.)</p>
                </div>
            }
            @if (!string.IsNullOrEmpty(Model.ExternalReference))
            {
                var matchingIds = GetMatchingCompanyIds();
                if( !string.IsNullOrEmpty(matchingIds))
                {
                    <div style="display: none">
                        Potential Matching Companys' Constituent IDs: @matchingIds
                    </div>
                }
            }
        </div>
    }
    else
    {
        <div class="timms-info span3 status-btns">
            <input class="command btn-primary save" type="submit" value="@ApplicationController.COMMAND_SAVE" />
            @if (Model.OrderStatus == OrderStatus.Approved)
            { @Html.ActionLink("Close", "../Orders") }
            else
            { @Html.ActionLink("Cancel", "../Orders") }

        </div>
    }
    @functions{
        public IStoreService StoreService { get; set; }
        public IBackendService BackendService { get; set; }
        public bool IsBackEnd()
        {
            bool useBackEndService = false;
            IList<StoreOrderDetail> OrderDetails = StoreService.GetAll<StoreOrderDetail>(true).Where(detail => detail.Order.Id == Model.OrderId).ToList();
            foreach (var orderDetail in OrderDetails)
            {
                useBackEndService = useBackEndService || BackendService.IsProcessUsingBackend(orderDetail);
                if (useBackEndService) break;
            }            
            return useBackEndService;
        }
        
        public string GetMatchingCompanyIds()
        {
            var ids = string.Empty;
            var order = StoreService.GetAll<StoreOrder>(true).FirstOrDefault(o => o.Id == Model.OrderId);
            if (order != null && order.Company != null && order.Company.MatchingCompanyIds != null)
                ids = order.Company.MatchingCompanyIds.Replace("|", " ");

            return ids;            
        }
        
        public bool HasPendingTerms()
        {
            var pendingTerms = StoreService.GetAll<TermsConditionsInstance>()
                                            .Where(t => t.OrderId.Value == Model.OrderId && t.DateAgreedOn == null && string.IsNullOrEmpty(t.AcceptedBy))
                                            .ToList();

            return pendingTerms != null && pendingTerms.Count() > 0;
        }
  }
</div>

